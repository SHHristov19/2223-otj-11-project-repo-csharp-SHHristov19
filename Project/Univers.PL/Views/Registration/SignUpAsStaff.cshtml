@using Microsoft.AspNetCore.Html;
@using System.Text.Encodings.Web;
@using Microsoft.Extensions.WebEncoders.Testing;
@using System.Text.RegularExpressions;
@model Univers.Models.Models.UserModel

<link rel="stylesheet" href="~/css/LoginAndRegistration.css" asp-append-version="true" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cooltipz-css@2.2.2/cooltipz.css" />

@functions  
{
    /// <summary>
    /// Converts the specified <see cref="IHtmlContent"/> object to a string representation, using the specified <see cref="HtmlEncoder"/> to encode the output.
    /// </summary>
    /// <param name="content">The <see cref="IHtmlContent"/> object to convert to a string.</param>
    /// <param name="encoder">The <see cref="HtmlEncoder"/> to use for encoding the output. If null, the default <see cref="HtmlTestEncoder"/> is used.</param>
    /// <returns>A string representation of the specified <see cref="IHtmlContent"/> object.</returns>
    public string HtmlContentToString(IHtmlContent content, HtmlEncoder encoder = null)
    {
        if (encoder == null)
        {
            encoder = new HtmlTestEncoder();
        }

        using (var writer = new StringWriter())
        {
            content.WriteTo(writer, encoder);
            return writer.ToString();
        }
    }

    /// <summary>
    /// Extracts an error message from an HTML error message string, by parsing the message between the first ">" character and the last "<" character, and returning it as a plain string.
    /// </summary>
    /// <param name="errorMessage">The HTML error message string to extract the message from.</param>
    /// <returns>A plain string containing the error message, or null if no message can be extracted.</returns>
    public string GetTheErrorMessage(string errorMessage)
    { 
        int startIndex = errorMessage.IndexOf(">") + 13;
        int endIndex = errorMessage.LastIndexOf("<") - 2;
        string message;
        if (startIndex < errorMessage.Length)
        {
            message = Html.Raw(errorMessage.Substring(startIndex, endIndex - startIndex)).ToString();
        }
        else
        {
            message = null;
        }

        return message;
    }
}

@using (Html.BeginForm("AddUser", "Registration", FormMethod.Post))
{
    <div class="div3">
        <a href="SignUpAs"><img src="@Url.Content("~/images/Back.svg")" class="back" /></a><br /><br />

        <table style="width:85%;  height:70%; margin-left:12%; border-spacing: 0 10px; ">
            <tr>
                <td>
                    <div>
                        @Html.LabelFor(model => model.Username, "Потребителско име", new { @class = "title"})<br>
                        @Html.TextBoxFor(model => model.Username, new { @class = "tb2" }) 
                    </div>
                </td>
                <td>
                    <div>
                        @Html.LabelFor(model => model.FirstName, "Име", new { @class = "title"})<br>
                        @Html.TextBoxFor(model => model.FirstName, new { @class = "tb2"})
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <div>
                        @Html.LabelFor(model => model.Password, "Парола", new { @class = "title"})<br> 
                        @{
                            string errorMessage = @GetTheErrorMessage(@HtmlContentToString(@Html.ValidationMessageFor(model => model.Password)));
                            if(errorMessage != null)
                            {
                                <span aria-label="@errorMessage" data-cooltipz-dir="top" data-cooltipz-size="fit">
                                    @Html.PasswordFor(model => model.Password, new { @class = "tb2"})
                                </span>
                            }
                            else
                            { 
                                @Html.PasswordFor(model => model.Password, new { @class = "tb2"}) 
                            }
                        } 
                    </div>
                </td>
                <td>
                    <div>
                        @Html.LabelFor(model => model.MiddleName, "Презиме", new { @class = "title"})<br>
                        @Html.TextBoxFor(model => model.MiddleName, new { @class = "tb2", required = "required" })
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <div>
                        @Html.LabelFor(model => model.PasswordConfirmation, "Повторете паролата", new { @class = "title"})<br>
                        @Html.PasswordFor(model => model.PasswordConfirmation, new { @class = "tb2", required = "required" })
                    </div>
                </td>
                <td>
                    <div>
                        @Html.LabelFor(model => model.LastName, "Фамилия", new { @class = "title"})<br>
                        @Html.TextBoxFor(model => model.LastName, new { @class = "tb2", required = "required" })
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <div>
                        @Html.LabelFor(model => model.Email, "Email адрес", new { @class = "title"})<br>
                        @Html.TextBoxFor(model => model.Email, new { @class = "tb2", required = "required" })
                    </div>
                </td>
                <td>
                    <div>
                        @Html.LabelFor(model => model.PhoneNumber, "Телефон", new { @class = "title"})<br>
                        @Html.TextBoxFor(model => model.PhoneNumber, new { @class = "tb2", type="tel", required = "required" , pattern=@"/^+359\d{9}", placeholder="+359" })
                    </div>
                </td>
            </tr>
            <tr>
                <td>
                    <div>
                        @Html.LabelFor(model => model.Address, "Адрес", new { @class = "title"})<br>
                        @Html.TextBoxFor(model => model.Address, new { @class = "tb2", required = "required" })
                    </div>
                </td>
                <td>
                    <div>
                        @Html.LabelFor(model => model.Gender, "Пол", new { @class = "title"})<br>
                        @Html.DropDownListFor(model => model.Gender, new List<SelectListItem>
                        {
                            new SelectListItem { Text = "Мъж"},
                            new SelectListItem { Text = "Жена"}
                        },  new { @class = "tb2", required = "required"})
                    </div>
                </td>
            </tr>
        </table>

        <button class="button4" type="submit">Напред</button>
    </div>
}